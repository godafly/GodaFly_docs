<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer Contraseña - GodaFly</title>
  <link rel="icon" type="image/png" href="https://izsdbimupdsfgvnuwsuv.supabase.co/storage/v1/object/public/Assets/logos/appIcon.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background-color: #1a1a1a;
      border-radius: 20px;
      padding: 48px 40px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.05);
    }
    
    .logo {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .logo img {
      height: 56px;
      filter: drop-shadow(0 4px 12px rgba(37, 208, 151, 0.3));
    }
    
    .icon-container {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .icon-circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, rgba(37, 208, 151, 0.15) 0%, rgba(37, 208, 151, 0.05) 100%);
      border-radius: 50%;
      border: 2px solid rgba(37, 208, 151, 0.3);
    }
    
    .icon-circle svg {
      width: 36px;
      height: 36px;
      color: #25D097;
    }
    
    h1 {
      color: #ffffff;
      font-size: 26px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }
    
    .subtitle {
      color: #9CA3AF;
      text-align: center;
      margin-bottom: 32px;
      font-size: 15px;
      line-height: 1.5;
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    label {
      display: block;
      color: #E5E7EB;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .input-wrapper {
      position: relative;
    }
    
    input {
      width: 100%;
      padding: 16px 48px 16px 16px;
      background-color: #252525;
      border: 2px solid #333333;
      border-radius: 12px;
      color: #ffffff;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    
    input:focus {
      outline: none;
      border-color: #25D097;
      background-color: #2a2a2a;
      box-shadow: 0 0 0 4px rgba(37, 208, 151, 0.1);
    }
    
    input::placeholder {
      color: #6B7280;
    }
    
    input.input-error {
      border-color: #EF4444;
    }
    
    input.input-success {
      border-color: #25D097;
    }
    
    .toggle-password {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #6B7280;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }
    
    .toggle-password:hover {
      color: #9CA3AF;
    }
    
    .toggle-password svg {
      width: 20px;
      height: 20px;
    }
    
    .password-strength {
      margin-top: 12px;
    }
    
    .strength-bar {
      height: 4px;
      background-color: #333333;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .strength-fill {
      height: 100%;
      border-radius: 2px;
      transition: all 0.3s ease;
      width: 0%;
    }
    
    .strength-fill.weak { width: 25%; background-color: #EF4444; }
    .strength-fill.fair { width: 50%; background-color: #F59E0B; }
    .strength-fill.good { width: 75%; background-color: #10B981; }
    .strength-fill.strong { width: 100%; background-color: #25D097; }
    
    .strength-text {
      font-size: 12px;
      color: #6B7280;
    }
    
    .requirements {
      margin-top: 16px;
      padding: 16px;
      background-color: rgba(255,255,255,0.03);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .requirements-title {
      font-size: 12px;
      font-weight: 600;
      color: #9CA3AF;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .requirement {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #6B7280;
      margin-bottom: 8px;
      transition: color 0.2s;
    }
    
    .requirement:last-child {
      margin-bottom: 0;
    }
    
    .requirement.met {
      color: #25D097;
    }
    
    .requirement svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    
    .match-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .match-indicator.visible {
      opacity: 1;
    }
    
    .match-indicator.match {
      color: #25D097;
    }
    
    .match-indicator.no-match {
      color: #EF4444;
    }
    
    .match-indicator svg {
      width: 16px;
      height: 16px;
    }
    
    button[type="submit"] {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, #25D097 0%, #1AAE7A 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(37, 208, 151, 0.3);
    }
    
    button[type="submit"]:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 208, 151, 0.4);
    }
    
    button[type="submit"]:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button[type="submit"]:disabled {
      background: #333333;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .alert svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    
    .alert.error {
      background-color: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #FCA5A5;
    }
    
    .alert.warning {
      background-color: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #FCD34D;
    }
    
    /* Success State */
    .success-container {
      text-align: center;
      padding: 20px 0;
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, rgba(37, 208, 151, 0.2) 0%, rgba(37, 208, 151, 0.05) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      animation: scaleIn 0.5s ease;
    }
    
    .success-icon svg {
      width: 40px;
      height: 40px;
      color: #25D097;
    }
    
    @keyframes scaleIn {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .success-title {
      color: #ffffff;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .success-message {
      color: #9CA3AF;
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 32px;
    }
    
    .success-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      background-color: rgba(37, 208, 151, 0.1);
      color: #25D097;
      border: 1px solid rgba(37, 208, 151, 0.3);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .success-button:hover {
      background-color: rgba(37, 208, 151, 0.2);
    }
    
    /* Error State */
    .error-container {
      text-align: center;
      padding: 20px 0;
    }
    
    .error-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.05) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }
    
    .error-icon svg {
      width: 40px;
      height: 40px;
      color: #EF4444;
    }
    
    .error-title {
      color: #ffffff;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .error-message {
      color: #9CA3AF;
      font-size: 15px;
      line-height: 1.6;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-content {
      text-align: center;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(37, 208, 151, 0.2);
      border-top-color: #25D097;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    .loading-text {
      color: #ffffff;
      font-size: 16px;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .footer-text {
      color: #6B7280;
      font-size: 12px;
    }
    
    .footer-link {
      color: #25D097;
      text-decoration: none;
    }
    
    .footer-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p class="loading-text">Verificando enlace...</p>
    </div>
  </div>

  <div class="container">
    <div class="logo">
      <img src="https://izsdbimupdsfgvnuwsuv.supabase.co/storage/v1/object/public/Assets/logos/LogoGodaFly.png" alt="GodaFly">
    </div>
    
    <!-- Form -->
    <div id="formContainer">
      <div class="icon-container">
        <div class="icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
        </div>
      </div>
      
      <h1>Crear Nueva Contraseña</h1>
      <p class="subtitle">Ingresa una contraseña segura para proteger tu cuenta de GodaFly</p>
      
      <div id="alertMessage" class="alert"></div>
      
      <form id="resetForm">
        <div class="form-group">
          <label for="password">Nueva contraseña</label>
          <div class="input-wrapper">
            <input type="password" id="password" placeholder="Ingresa tu nueva contraseña" required autocomplete="new-password">
            <button type="button" class="toggle-password" data-target="password">
              <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
              </svg>
            </button>
          </div>
          
          <div class="password-strength">
            <div class="strength-bar">
              <div id="strengthFill" class="strength-fill"></div>
            </div>
            <p id="strengthText" class="strength-text">Ingresa una contraseña</p>
          </div>
        </div>
        
        <div class="requirements">
          <p class="requirements-title">Requisitos de seguridad</p>
          <div class="requirement" id="req-length">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Mínimo 8 caracteres</span>
          </div>
          <div class="requirement" id="req-uppercase">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Al menos una mayúscula</span>
          </div>
          <div class="requirement" id="req-lowercase">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Al menos una minúscula</span>
          </div>
          <div class="requirement" id="req-number">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Al menos un número</span>
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label for="confirmPassword">Confirmar contraseña</label>
          <div class="input-wrapper">
            <input type="password" id="confirmPassword" placeholder="Repite la contraseña" required autocomplete="new-password">
            <button type="button" class="toggle-password" data-target="confirmPassword">
              <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <svg class="eye-closed hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
              </svg>
            </button>
          </div>
          <div id="matchIndicator" class="match-indicator">
            <svg class="match-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <svg class="no-match-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span id="matchText"></span>
          </div>
        </div>
        
        <button type="submit" id="submitBtn" disabled>
          <span id="btnText">Guardar Nueva Contraseña</span>
          <div id="btnSpinner" class="spinner hidden"></div>
        </button>
      </form>
      
      <div class="footer">
        <p class="footer-text">¿Necesitas ayuda? <a href="mailto:godafly.info@gmail.com" class="footer-link">Contáctanos</a></p>
      </div>
    </div>
    
    <!-- Success -->
    <div id="successContainer" class="success-container hidden">
      <div class="success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h2 class="success-title">¡Contraseña Actualizada!</h2>
      <p class="success-message">Tu contraseña ha sido cambiada exitosamente. Ya puedes iniciar sesión en la app con tu nueva contraseña.</p>
      <button class="success-button" onclick="window.close()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Listo
      </button>
    </div>
    
    <!-- Error - Invalid Link -->
    <div id="errorContainer" class="error-container hidden">
      <div class="error-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <h2 class="error-title">Enlace Inválido</h2>
      <p class="error-message">Este enlace ha expirado o no es válido. Por favor, solicita un nuevo enlace de recuperación desde la app de GodaFly.</p>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://izsdbimupdsfgvnuwsuv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2RiaW11cGRzZmd2bnV3c3V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzMxMTgsImV4cCI6MjA4NDUwOTExOH0.wOJqxIldAU6XbSfLCMJRbBoNgwqYulK9yBP1mZAjDfw';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const formContainer = document.getElementById('formContainer');
    const successContainer = document.getElementById('successContainer');
    const errorContainer = document.getElementById('errorContainer');
    const resetForm = document.getElementById('resetForm');
    const alertMessage = document.getElementById('alertMessage');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const matchIndicator = document.getElementById('matchIndicator');
    const matchText = document.getElementById('matchText');
    
    // Password validation state
    let requirements = {
      length: false,
      uppercase: false,
      lowercase: false,
      number: false
    };
    
    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(btn => {
      btn.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const eyeOpen = this.querySelector('.eye-open');
        const eyeClosed = this.querySelector('.eye-closed');
        
        if (input.type === 'password') {
          input.type = 'text';
          eyeOpen.classList.add('hidden');
          eyeClosed.classList.remove('hidden');
        } else {
          input.type = 'password';
          eyeOpen.classList.remove('hidden');
          eyeClosed.classList.add('hidden');
        }
      });
    });
    
    // Check password requirements
    function checkPassword(password) {
      requirements.length = password.length >= 8;
      requirements.uppercase = /[A-Z]/.test(password);
      requirements.lowercase = /[a-z]/.test(password);
      requirements.number = /[0-9]/.test(password);
      
      // Update UI
      Object.keys(requirements).forEach(key => {
        const el = document.getElementById(`req-${key}`);
        if (requirements[key]) {
          el.classList.add('met');
        } else {
          el.classList.remove('met');
        }
      });
      
      // Calculate strength
      const metCount = Object.values(requirements).filter(Boolean).length;
      strengthFill.className = 'strength-fill';
      
      if (password.length === 0) {
        strengthText.textContent = 'Ingresa una contraseña';
        strengthFill.style.width = '0%';
      } else if (metCount <= 1) {
        strengthFill.classList.add('weak');
        strengthText.textContent = 'Contraseña débil';
      } else if (metCount === 2) {
        strengthFill.classList.add('fair');
        strengthText.textContent = 'Contraseña regular';
      } else if (metCount === 3) {
        strengthFill.classList.add('good');
        strengthText.textContent = 'Contraseña buena';
      } else {
        strengthFill.classList.add('strong');
        strengthText.textContent = 'Contraseña segura ✓';
      }
      
      checkMatch();
      updateSubmitButton();
    }
    
    // Check if passwords match
    function checkMatch() {
      const password = passwordInput.value;
      const confirm = confirmInput.value;
      const matchIcon = matchIndicator.querySelector('.match-icon');
      const noMatchIcon = matchIndicator.querySelector('.no-match-icon');
      
      if (confirm.length === 0) {
        matchIndicator.classList.remove('visible');
        confirmInput.classList.remove('input-success', 'input-error');
        return;
      }
      
      matchIndicator.classList.add('visible');
      
      if (password === confirm) {
        matchIndicator.classList.remove('no-match');
        matchIndicator.classList.add('match');
        matchText.textContent = 'Las contraseñas coinciden';
        matchIcon.classList.remove('hidden');
        noMatchIcon.classList.add('hidden');
        confirmInput.classList.remove('input-error');
        confirmInput.classList.add('input-success');
      } else {
        matchIndicator.classList.remove('match');
        matchIndicator.classList.add('no-match');
        matchText.textContent = 'Las contraseñas no coinciden';
        matchIcon.classList.add('hidden');
        noMatchIcon.classList.remove('hidden');
        confirmInput.classList.remove('input-success');
        confirmInput.classList.add('input-error');
      }
      
      updateSubmitButton();
    }
    
    // Update submit button state
    function updateSubmitButton() {
      const allRequirementsMet = Object.values(requirements).every(Boolean);
      const passwordsMatch = passwordInput.value === confirmInput.value && confirmInput.value.length > 0;
      
      submitBtn.disabled = !(allRequirementsMet && passwordsMatch);
    }
    
    // Event listeners for password validation
    passwordInput.addEventListener('input', (e) => checkPassword(e.target.value));
    confirmInput.addEventListener('input', checkMatch);
    
    // Show alert
    function showAlert(message, type = 'error') {
      alertMessage.className = `alert ${type}`;
      alertMessage.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${type === 'error' ? 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'}" />
        </svg>
        <span>${message}</span>
      `;
      alertMessage.style.display = 'flex';
    }
    
    function hideAlert() {
      alertMessage.style.display = 'none';
    }
    
    // Initialize
    async function init() {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const queryParams = new URLSearchParams(window.location.search);
      
      // Check for code (PKCE flow)
      const code = queryParams.get('code');
      if (code) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) {
          showErrorState();
          return;
        }
        hideLoading();
        return;
      }
      
      // Check for access_token (implicit flow)
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');
      
      if (accessToken) {
        const { error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken || ''
        });
        
        if (error) {
          showErrorState();
          return;
        }
        hideLoading();
        return;
      }
      
      // Check existing session
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        hideLoading();
        return;
      }
      
      showErrorState();
    }
    
    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }
    
    function showErrorState() {
      loadingOverlay.classList.add('hidden');
      formContainer.classList.add('hidden');
      errorContainer.classList.remove('hidden');
    }
    
    function showSuccessState() {
      formContainer.classList.add('hidden');
      successContainer.classList.remove('hidden');
    }
    
    // Form submission
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();
      
      const password = passwordInput.value;
      
      // Disable button and show spinner
      submitBtn.disabled = true;
      btnText.textContent = 'Guardando...';
      btnSpinner.classList.remove('hidden');
      
      try {
        const { data, error } = await supabase.auth.updateUser({
          password: password
        });
        
        if (error) {
          // Check for specific errors
          if (error.message.toLowerCase().includes('same') || error.message.toLowerCase().includes('different')) {
            showAlert('La nueva contraseña debe ser diferente a la anterior', 'warning');
          } else if (error.message.toLowerCase().includes('weak')) {
            showAlert('La contraseña es demasiado débil. Intenta con una más segura.', 'warning');
          } else {
            showAlert(error.message);
          }
          
          submitBtn.disabled = false;
          btnText.textContent = 'Guardar Nueva Contraseña';
          btnSpinner.classList.add('hidden');
          updateSubmitButton();
          return;
        }
        
        showSuccessState();
        
      } catch (err) {
        showAlert('Ocurrió un error. Por favor, intenta de nuevo.');
        submitBtn.disabled = false;
        btnText.textContent = 'Guardar Nueva Contraseña';
        btnSpinner.classList.add('hidden');
        updateSubmitButton();
      }
    });
    
    // Start
    init();
  </script>
</body>
</html>
